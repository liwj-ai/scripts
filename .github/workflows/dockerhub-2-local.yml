name: Dockerhub 2 local

on:
  workflow_dispatch:
    inputs:
      source_image:
        description: 'æºé•œåƒä¿¡æ¯ (e.g., registry/source:tag)'
        required: true
        type: string
      target_image:
        description: 'ç›®æ ‡é˜¿é‡Œäº‘é•œåƒä¿¡æ¯ (e.g., registry/target:tag)'
        required: true
        type: string
      local_image:
        description: 'æœ¬åœ°ä»“åº“é•œåƒä¿¡æ¯ (e.g., registry/local:tag)'
        required: true
        type: string
      local_registry_token:
        description: 'æœ¬åœ°ä»“åº“ç™»å½•ä¿¡æ¯ (e.g., docker login registry --username xxx --password yyy)'
        required: false
        type: string
jobs:
  copy-image-to-aliyun:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout (required by GitHub Actions even if not used)
        uses: actions/checkout@v4

      - name: æ‰©å¤§ç©ºé—´
        run: |
          sudo rm -rf /usr/local/lib/android/sdk
          sudo rm -rf /opt/hostedtoolcache
          
      - name: Pull source image
        run: |
          docker pull "${{ github.event.inputs.source_image }}"

      - name: Tag to target image
        run: |
          docker tag "${{ github.event.inputs.source_image }}" "${{ github.event.inputs.target_image }}"
          
      - name: aliyun registry login
        env:
          DOCKER_USER: ${{ secrets.ALIYUN_DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.ALIYUN_DOCKER_PASSWORD }}
          
        run: |
          echo "$DOCKER_PASSWORD" | docker login registry.cn-hangzhou.aliyuncs.com --username "$DOCKER_USER" --password-stdin
          
      - name: Push target image
        run: |
          docker push "${{ github.event.inputs.target_image }}"

      - name: Remove local images
        run: |
          docker rmi "${{ github.event.inputs.source_image }}" "${{ github.event.inputs.target_image }}"

  copy-image-to-local:
    runs-on: tps-36.34
    needs: [copy-image-to-aliyun]

    steps:
      - name: Checkout (required by GitHub Actions even if not used)
        uses: actions/checkout@v4

      - name: aliyun registry login
        env:
          DOCKER_USER: ${{ secrets.ALIYUN_DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.ALIYUN_DOCKER_PASSWORD }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login registry.cn-hangzhou.aliyuncs.com --username "$DOCKER_USER" --password-stdin

      - name: Pull source image
        run: |
          docker pull "${{ github.event.inputs.target_image }}"

      - name: Tag to target image
        run: |
          docker tag "${{ github.event.inputs.target_image }}" "${{ github.event.inputs.local_image }}"
          
      - name: push image
        env:
          IMAGE: ${{ github.event.inputs.local_image }}
          FALLBACK_CMD: ${{ github.event.inputs.local_registry_token }}
        run: |
          echo "å°è¯•æ¨é€é•œåƒ: $IMAGE"
          if docker push "$IMAGE"; then
            echo "æ¨é€æˆåŠŸ"
          else
            echo "æ¨é€å¤±è´¥ï¼Œå‡†å¤‡è§£æå¤‡ç”¨ç™»å½•å‘½ä»¤..."

            if [ -z "$FALLBACK_CMD" ]; then
              echo "æœªæä¾›å¤‡ç”¨ç™»å½•å‘½ä»¤ï¼Œç»ˆæ­¢"
              exit 1
            fi

            # æå– registryã€usernameã€password
            REGISTRY=$(echo "$FALLBACK_CMD" | awk '{for(i=1;i<=NF;i++) if ($i == "login") print $(i+1)}')
            USERNAME=$(echo "$FALLBACK_CMD" | grep -oP -- '--username[= ]\K[^ ]+')
            PASSWORD=$(echo "$FALLBACK_CMD" | grep -oP -- '--password[= ]\K[^ ]+')

            if [ -z "$REGISTRY" ] || [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
              echo "âŒ è§£æå¤±è´¥ï¼Œè¯·ç¡®è®¤å‘½ä»¤æ ¼å¼æ­£ç¡®"
              exit 1
            fi

            echo "ğŸ” ä½¿ç”¨å®‰å…¨æ–¹å¼ç™»å½• $REGISTRY ç”¨æˆ·: $USERNAME"
            echo "$PASSWORD" | docker login "$REGISTRY" --username "$USERNAME" --password-stdin

            echo "ğŸ” é‡è¯•æ¨é€é•œåƒ..."
            docker push "$IMAGE"
          fi

